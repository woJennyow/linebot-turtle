// LINE Bot æµ·é¾œæ¹¯éŠæˆ² - æ•´åˆç‰ˆï¼ˆæ”¯æ´æ•¸å­—é¸é¡Œèˆ‡æ•…äº‹é‚„åŽŸé¸æ“‡é¡Œï¼‰

const line = require('@line/bot-sdk');
const express = require('express');

const config = {
  channelAccessToken: 'cTOKJdSRlL8LYBgrQtKCB/DZ3ajAOHYN2aZyh3j+Gs4j6sK6lo78Um29Vo+W34RQi2jzRUecamad5II9RnKCMkZ5EeSBkb8TQTGbhOdU7dMuUXz9aMYvGnqQQ+GJqHd/NeRTggi5ZQPMpSPf8uy0iwdB04t89/1O/w1cDnyilFU=',
  channelSecret: '7c2ce056206edad1c9adb78946f446a7'
};

const client = new line.Client(config);
const app = express();
app.use(line.middleware(config));
app.use(express.json());

const storyData = {
  intro: "é¡Œå¹¹ï¼šè‡ªå¾žé˜¿æ˜Žè¢«çˆ¸çˆ¸èƒ–æä¸€é “ä¹‹å¾Œå°±é–‹å§‹é »ç¹åœ°æ’¿ç ´çˆ›ï¼Œçœ‹è¦‹é˜¿æ˜Žé€™éº¼åšï¼Œå§Šå§Šçš„çœ¼ç¥žå¾ˆæ˜¯è¤‡é›œã€‚\nè«‹è¼¸å…¥ä¸€å€‹æ•¸å­—ä»¥é¸æ“‡äº’å‹•å°è±¡ï¼š\n1. é˜¿æ˜Ž\n2. çˆ¸çˆ¸\n3. èƒ–æä¸€é “\n4. ç ´çˆ›\n5. å§Šå§Š\n6. çœ¼ç¥ž\n7. é‚„åŽŸæ•…äº‹ï¼ˆçµå±€æŒ‘æˆ°ï¼‰",

  interactions: {
    1: {
      keyword: "é˜¿æ˜Ž",
      questions: [
        "1. é˜¿æ˜Žæ˜¯å°å­©å—Žï¼Ÿ",
        "2. é˜¿æ˜Žçš„å€‹æ€§è¨˜ä»‡å—Žï¼Ÿ",
        "3. é˜¿æ˜Žå¤©æ€§é ‘åŠ£å—Žï¼Ÿ",
        "4. é˜¿æ˜Žæœ‰ç‰¹æ®Šä¹‹è™•å—Žï¼Ÿ",
        "5. é˜¿æ˜ŽæŒ¨æ‰“å¾Œæ˜¯æ•…æ„æƒ¹çˆ¸çˆ¸ç”Ÿæ°£å—Žï¼Ÿ"
      ],
      answers: {
        1: "æ˜¯ã€‚å†å¹¾å¹´æ‰æœƒä¸Šå°å­¸ã€‚",
        2: "å¦ã€‚",
        3: "å¦ã€‚ä»–æ˜¯å€‹æœƒå¹«å®¶è£¡å¹¹è¾²æ´»åšå®¶å‹™çš„ä¹–å­©å­ã€‚",
        4: "æ˜¯ã€‚ä»–ç‰¹åˆ¥å–œæ­¡åšä¸€ä»¶äº‹ï¼Œè€Œä¸”æœ‰å¤©ä»½ï¼",
        5: "å¦ã€‚æ°å¥½ç›¸åï¼Œæ˜¯ç‚ºäº†è®“ä»¥å¾Œçˆ¸çˆ¸ä¸è¦å†ä¸é–‹å¿ƒäº†ã€‚"
      }
    },
    2: {
      keyword: "çˆ¸çˆ¸",
      questions: [
        "1. è·Ÿçˆ¸çˆ¸è·æ¥­æœ‰é—œå—Žï¼Ÿ",
        "2. çˆ¸çˆ¸è„¾æ°£æš´èºå—Žï¼Ÿ",
        "3. çˆ¸çˆ¸è¨ŽåŽ­é˜¿æ˜Žå—Žï¼Ÿ",
        "4. çˆ¸çˆ¸é…—é…’å—Žï¼Ÿ",
        "5. çˆ¸çˆ¸çœ‹ä¸èµ·é˜¿æ˜Žå—Žï¼Ÿ",
        "6. æ˜¯è¦ªç”Ÿçˆ¶è¦ªå—Žï¼Ÿ"
      ],
      answers: {
        1: "å¦ã€‚çˆ¸çˆ¸åªæ˜¯å€‹è²§å›°èŒ¶è¾²ã€‚",
        2: "å¦ã€‚çˆ¸çˆ¸ç”Ÿæ°£éƒ½æœ‰åŽŸå› ã€‚",
        3: "å¦ã€‚å°ä»–å¯„äºˆåŽšæœ›ã€‚",
        4: "å¦ã€‚èªçœŸå·¥ä½œã€‚",
        5: "å¦ã€‚å› ç‚ºé‡è¦–æ‰è²¬æ‰“ã€‚",
        6: "æ˜¯ã€‚çµ•å°æ˜¯è¦ªç”Ÿçš„ã€‚"
      }
    },
    3: {
      keyword: "èƒ–æä¸€é “",
      questions: [
        "1. çœŸçš„æ˜¯é˜¿æ˜ŽéŒ¯ï¼Ÿ",
        "2. æ˜¯ç‚ºäº†åˆ¶æ­¢é˜¿æ˜Žåšäº‹ï¼Ÿ",
        "3. æ˜¯ç‚ºäº†è¶•èµ°ä»–ï¼Ÿ",
        "4. çœŸçš„æ‰“äº†å—Žï¼Ÿ",
        "5. æ˜¯è¦ªçˆ¹æ‰“çš„å—Žï¼Ÿ"
      ],
      answers: {
        1: "æ˜¯ã€‚é˜¿æ˜ŽçŸ¥éŒ¯äº†ã€‚",
        2: "æ˜¯ã€‚çˆ¸çˆ¸å–Šï¼šã€Žæˆ‘çš„ç‰†å£ï¼æˆ‘çš„åœ°æ¿ï¼ã€",
        3: "å¦ã€‚",
        4: "æ˜¯ã€‚ç—›å¾—è¦å‘½ã€‚",
        5: "æ˜¯ã€‚æ²’å•é¡Œã€‚"
      }
    },
    4: {
      keyword: "ç ´çˆ›",
      questions: [
        "1. å¯ä»¥è³£éŒ¢å—Žï¼Ÿ",
        "2. æœƒæ”¾å®¶è£¡å—Žï¼Ÿ",
        "3. å¯åšå…¶ä»–ç”¨é€”ï¼Ÿ",
        "4. å¯å‚·äººå—Žï¼Ÿ",
        "5. å¯æˆæ­¦å™¨å—Žï¼Ÿ"
      ],
      answers: {
        1: "æ˜¯ã€‚ä½†ä¸å€¼éŒ¢ã€‚",
        2: "æ˜¯ã€‚ä½†ä¸æ˜¯ä¸»è¦ç›®çš„ã€‚",
        3: "æ˜¯ã€‚èˆ‡ç‰¹æ®Šä¹‹è™•æœ‰é—œã€‚",
        4: "å¦ã€‚é¢¨å¹å°±èµ°ã€‚",
        5: "èˆ‡æ­¤ç„¡é—œã€‚"
      }
    },
    5: {
      keyword: "å§Šå§Š",
      questions: [
        "1. è¨ŽåŽ­é˜¿æ˜Žå—Žï¼Ÿ",
        "2. è·Ÿè·æ¥­æœ‰é—œå—Žï¼Ÿ",
        "3. æ˜¯è¦ªç”Ÿçš„å—Žï¼Ÿ",
        "4. æ˜¯ç«¥é¤Šåª³å—Žï¼Ÿ"
      ],
      answers: {
        1: "å¦ã€‚è¨ŽåŽ­æ–‡å…·è¢«æ‹¿èµ°ã€‚",
        2: "å¦ã€‚å§Šå§Šåœ¨ä¸Šå°å­¸ã€‚",
        3: "æ˜¯ã€‚",
        4: "å¦ã€‚ä»–å€‘æ˜¯è¦ªå§å¼Ÿã€‚"
      }
    },
    6: {
      keyword: "çœ¼ç¥ž",
      questions: [
        "1. æœ‰æ“”æ†‚å—Žï¼Ÿ",
        "2. æœ‰é„™å¤·å—Žï¼Ÿ",
        "3. æœ‰æ®ºæ°£å—Žï¼Ÿ",
        "4. æœ‰ç”Ÿæ°£å—Žï¼Ÿ"
      ],
      answers: {
        1: "æ˜¯ã€‚å§Šå§ŠçŸ¥é“çˆ¸çˆ¸å°ä»–æœ‰æœŸå¾…ã€‚",
        2: "å¦ã€‚å¥¹å°å¼Ÿå¼Ÿå¥½ã€‚",
        3: "å¦ã€‚æœ‰é»žè¨ŽåŽ­è€Œå·²ã€‚",
        4: "æœ‰ã€‚ã€Žä¸è¦å†æ‹¿äº†ã€å¥¹èªªã€‚"
      }
    },
  },

  ending: {
    questions: [
      "ä¸€ã€é˜¿æ˜Žæ’¿çš„ç ´çˆ›æœ‰ä»€éº¼å…±åŒçš„ç‰¹æ€§ï¼Ÿ\nA. ç´™é¡ž\nB. å¯ä»¥è³£å¾ˆå¤šéŒ¢è²¼è£œå®¶ç”¨\nC. èƒ½è®“çˆ¸çˆ¸æ›´ç”Ÿæ°£\nD. è£½ä½œæ­¦å™¨çš„åŽŸææ–™",
      "äºŒã€çˆ¸çˆ¸æ‰“é˜¿æ˜Žçš„åŽŸå› æ˜¯ï¼Ÿ\nA. æ¯€æå‚¢ä¿±å’Œæˆ¿å±‹ä½¿å…¶ç„¡æ³•ä½¿ç”¨\nB. é…—é…’\nC. ç‚ºäº†è¶•èµ°ä¸æ˜¯è¦ªç”Ÿçš„é˜¿æ˜Ž\nD. åˆ¶æ­¢é˜¿æ˜Žç¹¼çºŒåšæŸä»¶äº‹",
      "ä¸‰ã€å§Šå§Šå’Œé˜¿æ˜Žçš„ä¸»è¦çŸ›ç›¾æ˜¯ï¼Ÿ\nA. æ¶æ–‡å…·\nB. å®¶äº‹å’Œè¾²æ´»éŽæ–¼ç¹é‡ï¼Œç›¸äº’æŽ¨å¸å·¥ä½œ\nC. å·éŒ¢\nD. å§Šå§Šä¸æƒ³æˆç‚ºé˜¿æ˜Žçš„ç«¥é¤Šåª³",
      "å››ã€é˜¿æ˜Žçš„ç‰¹æ®Šä¹‹è™•ç©¶ç«Ÿæ˜¯ä»€éº¼ï¼Ÿ\nA. ä¸€é›™èƒ½å¾žç ´çˆ›ä¸­æ‰¾å‡ºå€¼éŒ¢ç‰©å“çš„æ…§çœ¼\nB. å¦‚é‹¼éµèˆ¬æ‰›æ‰“æŒ¨æçš„èº«è»€\nC. æ„›ç•«ç•«çš„æ‰‹\nD. æ­¦å™¨å¤§å¸«"
    ],
    answers: ['A', 'D', 'A', 'C']
  }
};

let userState = {};

app.post('/webhook', async (req, res) => {
  try {
    const events = req.body.events;
    const results = await Promise.all(events.map(handleEvent));
    res.status(200).json(results);
  } catch (err) {
    console.error('Webhook Error:', err);
    res.status(500).end();
  }
});

async function handleEvent(event) {
  const userId = event.source.userId;
  const msg = event.message.text.trim();
  const state = userState[userId] || {};

  if (msg === 'é–‹å§‹éŠæˆ²') {
    userState[userId] = {}; // reset state
    return reply(event, storyData.intro);
  }

  if (msg === '0') {
    delete userState[userId].topic;
    return reply(event, storyData.intro);
  }

  if (!state.topic && /^[1-6]$/.test(msg)) {
    const topic = storyData.interactions[msg];
    userState[userId].topic = msg;
    return reply(event, `ä½ é¸æ“‡çš„æ˜¯ã€Œ${topic.keyword}ã€è«‹è¼¸å…¥é¡Œè™Ÿï¼š\n${topic.questions.join('\n')}`);
  }

  if (state.topic && /^[1-9]$/.test(msg)) {
    const topic = storyData.interactions[state.topic];
    const question = topic?.questions[msg - 1];
    const answer = topic?.answers[msg];
    if (!question || !answer) {
      return reply(event, `â— æ‰¾ä¸åˆ°é€™é¡Œï¼Œè«‹è¼¸å…¥æ­£ç¢ºé¡Œè™Ÿæˆ–è¼¸å…¥ 0 è¿”å›žä¸»é¡Œé¸å–®ã€‚`);
    }
    return reply(event, `å•é¡Œï¼šã€Œ${question}ã€\nç­”æ¡ˆï¼š${answer}\n\næ‚¨å¯ä»¥ç¹¼çºŒè¼¸å…¥æ•¸å­—å•åŒä¸»é¡Œçš„å•é¡Œï¼Œæˆ–è¼¸å…¥ 0 æ›ä¸»é¡Œã€‚`);
  }

  if (msg === '7') {
    userState[userId] = { endingStep: 0, correct: 0 };
    return reply(event, `ðŸ§© çµå±€æŒ‘æˆ°é–‹å§‹ï¼è«‹å›žç­”ä¸‹åˆ—å•é¡Œï¼Œåƒ…èƒ½è¼¸å…¥ A~Dã€‚\n${storyData.ending.questions[0]}`);
  }

  if (state.hasOwnProperty('endingStep')) {
    const step = state.endingStep;
    const answer = storyData.ending.answers[step];
    if (!/^[A-Da-d]$/.test(msg)) {
      return reply(event, `è«‹è¼¸å…¥ A~D ä½œç‚ºé¸é …ï¼\n${storyData.ending.questions[step]}`);
    }
    if (msg.toUpperCase() === answer) {
      userState[userId].correct++;
      userState[userId].endingStep++;
      if (userState[userId].endingStep >= storyData.ending.questions.length) {
        const passed = userState[userId].correct === 4;
        delete userState[userId];
        return reply(event, passed ? 'ðŸŽ‰ æ­å–œä½ æ­£ç¢ºé‚„åŽŸæ•´å€‹æ•…äº‹ï¼æ•…äº‹æ˜¯ã€Šé­¯å†°èŠ±ã€‹ç¬¬ä¸€ç« ä¸­çš„é€™å€‹æ®µè½ï¼šèªªèµ·ç•«ç•«ï¼Œå†æ²’æœ‰ä½¿å¼Ÿå¼Ÿæ›´å–œæ­¡çš„äº‹æƒ…äº†ã€‚èŒ¶å¦¹è¨˜å¾—å…­å¹´å‰å…¥å­¸å¾Œæœ‰äº†è Ÿç­†ã€åœ–ç´™ç­‰æ±è¥¿ï¼Œå¾žé‚£æ™‚å€™èµ·ï¼Œå¼Ÿå¼Ÿå°±æ‡‚å¾—äº†æœ‰ä»¶å«åšã€Œç•«ç•«ã€é€™éº¼å›žäº‹ã€‚é‚£æ™‚ä»–æ‰å››æ­²ï¼Œè¦‹äº†æ±è¥¿å°±è¦ï¼Œè€Œä¸”åˆ°äº†æ‰‹å°±ä¸€å®šè¦çŽ©å€‹å¤ ï¼Œéžåˆ°é‚£æ±è¥¿æ”¯é›¢ç ´ç¢Žä¸è‚¯æ”¾æ‰‹ã€‚ç‰¹åˆ¥æ˜¯å¥¹é‚£ç›’å…«æžè£çš„è Ÿç­†ï¼Œæ¯æ¬¡è¢«çœ‹è¦‹å°±åµè‘—è¦ä¸€æžã€‚èµ·å§‹æ˜¯æ’•ä¸‹æ—¥æ›†ä¾†å¡—ï¼Œåˆ°å¾Œä¾†ï¼Œç‰†å£ã€åœ°é¢ä¸Šã€æ¡Œæ¤…ä¸Šï¼Œåˆ°è™•éƒ½è¦ç•«ä¸Šé‚£äº›åœ“åœ“æ–¹æ–¹çš„å¤æ€ªåœ–æ¨£ã€‚çˆ¸çˆ¸æœ‰ä¸€æ¬¡æ°£å¾—æ‰ä½ä»–ï¼Œç‹ ç‹ åœ°æäº†ä¸€é “å±è‚¡ï¼Œä»–é€™æ‰ä¸æ•¢å†äº‚ç•«ã€‚å¼Ÿå¼Ÿä¹ŸçœŸå¤ è°æ˜Žï¼Œé‚£ä»¥å¾Œçœ‹åˆ°äº† ç´™å¼µä¹‹é¡žâ€”â€”å¦‚è²·æ±è¥¿å›žä¾†æ™‚çš„åŒ…è£ç´™ã€ ç´™è¢‹ç­‰ï¼Œæˆ–è€…åœ¨é¦¬è·¯ä¸Šæ€åˆ°çš„çˆ›ç´™ï¼Œä»–éƒ½è¦ç´°å¿ƒå­˜ä¸‹ä¾†ï¼Œå¼„å¹³ï¼Œæ”¶è—ï¼Œæœ‰äº†è Ÿç­†å°±ç•«ã€‚å¦‚ä»Šæƒ³èµ·ä¾†ï¼Œé‚£æ™‚çš„å¼Ÿå¼Ÿé›–ç„¶å¯æ„›ï¼Œä½†åˆæ˜¯æ€Žæ¨£åœ°ä½¿å¥¹å‚·å¿ƒå•Šã€‚å¥¹å‰›å…¥å­¸ï¼Œçœ¼çœ‹è‘—é‚£æ¨£é‡è¦çš„æ±è¥¿â€”â€”å¥¹é‚£æ™‚åªè¦ºå¾—ä¸ç®¡æ˜¯é‰›ç­†å˜ã€æ©¡çš®å˜ã€ç­†ç›’ã€å¢Šæ¿ç­‰ç­‰ï¼Œæ²’æœ‰ä¸€æ¨£ä¸æ˜¯æŒºé‡è¦çš„â€”â€”å»æ•™å¼Ÿå¼Ÿä¸€æžæŽ¥ä¸€æžçµ¦è¹§è¹‹ã€‚çˆ¸çˆ¸åª½åª½åˆé‚£æ¨£è¢’ä»–ï¼Œä¸çµ¦ä»–å°±è¦æŒ¨ç½µæŒ¨æ‰“ã€‚å¥¹ä¸æ›‰å¾—ç‚ºé€™äº›æµäº†å¤šå°‘çœ¼æ·šã€‚æ²’æ³•ï¼Œå¥¹åªå¥½æŠŠå¼Ÿå¼ŸçŽ©è†©ä¸Ÿä¸‹çš„è Ÿç­†é ­å…’æ€èµ·ä¾†ç”¨ã€‚!' : 'ðŸ˜¢ å¾ˆéºæ†¾ï¼Œä½ å›žç­”éŒ¯äº†å¹¾é¡Œï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚è¼¸å…¥ 7 é‡ä¾†çµå±€æŒ‘æˆ°æˆ–è¼¸å…¥ 0 å›žä¸»é¡Œé¸å–®ã€‚');
      } else {
        return reply(event, `âœ… ç­”å°äº†ï¼ä¸‹ä¸€é¡Œï¼š\n${storyData.ending.questions[userState[userId].endingStep]}`);
      }
    } else {
      return reply(event, `âŒ éŒ¯äº†ï¼Œå†æƒ³æƒ³ï¼è«‹é‡æ–°å›žç­”ï¼š\n${storyData.ending.questions[step]}`);
    }
  }

  return reply(event, 'è«‹è¼¸å…¥ã€Œé–‹å§‹éŠæˆ²ã€ï¼Œæˆ– 1~6 é¸æ“‡ä¸»é¡Œï¼Œæˆ–è¼¸å…¥ 7 é–‹å§‹çµå±€æŒ‘æˆ°ã€‚');
}

function reply(event, text) {
  return client.replyMessage(event.replyToken, { type: 'text', text });
}

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Server is running on port ${port}`);
});

